#!/bin/bash

current_location="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Function to run PowerShell script
run_powershell() {
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    version_file="$script_dir/Version"

    previous_cli_version=$(<"$version_file")

    if ! command -v git >/dev/null 2>&1; then
        echo "Git is not installed or not in PATH."
    else
        git -C "$script_dir" fetch origin --prune --quiet
        remote_version=$(git -C "$script_dir" show origin/main:Version)
        if [[ $(printf '%s\n%s\n' "$remote_version" "$previous_cli_version" | sort -V | tail -n1) == "$remote_version" ]] \
        && [[ "$remote_version" != "$previous_cli_version" ]]; then
            read -r -p "A new version of DX CLI ($remote_version) is available.
You can update now or continue using the current version.
Update now? [Y/N] (default: N): " user_input

            user_input=$(echo "$user_input" | tr '[:upper:]' '[:lower:]')

            if [[ "$user_input" =~ ^(yes|y)$ ]]; then
                git -C "$script_dir" pull
            fi
        fi
    fi
    
    "$1" -NoProfile -ExecutionPolicy Bypass -File "$current_location/../StartChat.ps1" -PreviousCliVersion "$previous_cli_version"
}

# Check for PowerShell (pwsh)
if command -v pwsh >/dev/null 2>&1; then
    run_powershell pwsh
    exit $?
fi

echo "PowerShell is not installed. Install PowerShell before using DX CLI."

OS_TYPE="$(uname -s 2>/dev/null || echo Windows_NT)"

if [[ "$OS_TYPE" == "Darwin" ]]; then
    echo "See https://learn.microsoft.com/en-us/powershell/scripting/install/install-powershell-on-macos"
    exit 1
fi

if [[ "$OS_TYPE" == "Linux" ]]; then
    echo "See https://learn.microsoft.com/en-us/powershell/scripting/install/install-powershell-on-linux"
    exit 1
fi

echo "See https://learn.microsoft.com/en-us/powershell/scripting/install/install-powershell"
exit 1